{% extends "layout.html" %}

{% block title %}ëœë¤ ì±„íŒ…{% endblock %}

{% block content %}

<div class="container py-5">

    <!-- Page Title -->
    <div class="mb-4">
        <h2 class="fw-bold">ğŸ’¬ ëœë¤ ì±„íŒ…</h2>
        <p class="text-muted small">
            ìƒˆë¡œìš´ ì‚¬ìš©ìì™€ ëœë¤ìœ¼ë¡œ ë§¤ì¹­ë˜ì–´ ì‹¤ì‹œê°„ ì±„íŒ…ì„ ì¦ê²¨ë³´ì„¸ìš”.
        </p>
    </div>

    <div class="row">

        <!-- Chat Area -->
        <div class="col-lg-8">
            <div class="card shadow-sm rounded-4 border-0">
                <div class="card-header bg-white fw-bold">
                    ì±„íŒ…ë°©
                </div>

                <div class="card-body" 
                     id="chat-box"
                     style="height:400px; overflow-y:auto; background:#f8f9fa;">

                    <!-- ë©”ì‹œì§€ ì¶œë ¥ ì˜ì—­ -->

                </div>

                <div class="card-footer bg-white">
                    <div class="input-group">
                        <input type="text"
                               id="message-input"
                               class="form-control"
                               placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                               autocomplete="off">
                        <button class="btn btn-primary" id="send-btn">
                            ì „ì†¡
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Side Panel -->
        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="card shadow-sm rounded-4 border-0">
                <div class="card-body text-center">

                    <h6 class="fw-bold mb-3">ëœë¤ ë§¤ì¹­</h6>

                    <p class="small text-muted">
                        ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëœë¤ ì‚¬ìš©ìì™€ ì—°ê²°ë©ë‹ˆë‹¤.
                    </p>

                    <button class="btn btn-primary w-100 mb-2"
                            id="match-btn">
                        ë§¤ì¹­ ì‹œì‘
                    </button>

                    <button class="btn btn-outline-danger w-100"
                            id="leave-btn">
                        ì±„íŒ… ì¢…ë£Œ
                    </button>

                    <hr>

                    <p class="small text-muted mb-1">
                        ìƒíƒœ:
                        <span id="status-text" class="fw-bold text-secondary">
                            ëŒ€ê¸°ì¤‘
                        </span>
                    </p>

                </div>
            </div>
        </div>

    </div>
</div>


<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
    const socket = io();
    const chatBox = document.getElementById("chat-box");
    const messageInput = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    const matchBtn = document.getElementById("match-btn");
    const leaveBtn = document.getElementById("leave-btn");
    const statusText = document.getElementById("status-text");

    let currentRoom = null;

    socket.on("connect", function () {
        console.log("ì„œë²„ ì—°ê²°ë¨");
    });

    // ë§¤ì¹­ ìš”ì²­
   matchBtn.addEventListener("click", function () {

    if (currentRoom) return;   // ì´ë¯¸ ì±„íŒ…ì¤‘ì´ë©´ ë§‰ê¸°

    matchBtn.disabled = true;  // ğŸ”¥ ë²„íŠ¼ ì ê¸ˆ

    socket.emit("random_match");

    statusText.innerText = "ë§¤ì¹­ì¤‘...";
    statusText.classList.remove("text-secondary");
    statusText.classList.add("text-warning");
});

    // ë§¤ì¹­ ì™„ë£Œ
    socket.on("matched", function (data) {
        currentRoom = data.room;
        statusText.innerText = "ì±„íŒ…ì¤‘";
        statusText.classList.remove("text-warning");
        statusText.classList.add("text-success");

        addMessage("ğŸ“¢ ì‹œìŠ¤í…œ", "ìƒëŒ€ë°©ê³¼ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

    // ë©”ì‹œì§€ ìˆ˜ì‹ 
    socket.on("receive_message", function (data) {
        addMessage(data.user, data.message);
    });

    // ë©”ì‹œì§€ ì „ì†¡
    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            sendMessage();
        }
    });

    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message || !currentRoom) return;

        socket.emit("send_message", {
            room: currentRoom,
            message: message
        });

        addMessage("ë‚˜", message);
        messageInput.value = "";
    }

    // ì±„íŒ… ì¢…ë£Œ
    leaveBtn.addEventListener("click", function () {
    if (currentRoom) {
        socket.emit("leave_room", { room: currentRoom });

        addMessage("ğŸ“¢ ì‹œìŠ¤í…œ", "ì±„íŒ…ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");

        currentRoom = null;

        statusText.innerText = "ëŒ€ê¸°ì¤‘";
        statusText.classList.remove("text-success");
        statusText.classList.add("text-secondary");

        matchBtn.disabled = false;   // ğŸ”¥ ë‹¤ì‹œ í™œì„±í™”
    }
});

    // ë©”ì‹œì§€ í™”ë©´ì— ì¶”ê°€
    function addMessage(user, message) {
        const div = document.createElement("div");
        div.classList.add("mb-2");

        div.innerHTML = `
            <strong>${user}:</strong>
            <span>${message}</span>
        `;

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

{% endblock %}
