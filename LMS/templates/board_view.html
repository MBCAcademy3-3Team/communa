{% extends 'layout.html' %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-md-10">
            <h2 class="mb-4">ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°</h2>

            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0">{{ board.title }}</h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3 border-bottom pb-2">
                        <div class="col-md-6">
                            <strong>ì‘ì„±ì:</strong> {{ board.writer_name }}
                            <span class="text-muted">({{ board.writer_uid }})</span>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <strong>ì‘ì„±ì¼:</strong>
                            {{ board.created_at.strftime('%Y-%m-%d %H:%M') if board.created_at }}
                        </div>
                    </div>

                    <div class="view-content mb-5" style="min-height: 150px;">
                        {{ board.content }}
                    </div>

                    <div class="text-center mb-5">
                        <button id="like-btn" class="btn btn-outline-danger btn-lg {% if user_liked %}active{% endif %}"
                                onclick="toggleLike({{ board.id }})">
                            <span id="like-icon">{% if user_liked %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                            ì¢‹ì•„ìš” <span id="like-count">{{ board.likes }}</span>
                        </button>
                    </div>

                    <div class="text-center pb-4 border-bottom">
                        <a href="/board" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
                        {% if session.get('user_id') == board.member_id %}
                        <a href="/board/edit/{{ board.id }}" class="btn btn-warning">ìˆ˜ì •</a>
                        <a href="/board/delete/{{ board.id }}" class="btn btn-danger"
                           onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                        {% endif %}
                    </div>


                    <div class="comment-section mt-5">
                        <h5>ëŒ“ê¸€ <span class="text-primary">{{ comments|length }}</span></h5>

                        <div class="card my-3">
                            <div class="card-body">
                                <div class="input-group">
                                    <textarea id="comment-content" class="form-control" rows="2" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”."></textarea>
                                    <button class="btn btn-primary" onclick="submitComment(null)">ë“±ë¡</button>
                                </div>
                            </div>
                        </div>

                        {% macro render_comment(comment_list) %}
                            {% for c in comment_list %}
                            <div class="mb-3 {% if c.parent_id %}ms-4 ps-3 border-start{% endif %}" id="comment-{{ c.id }}">
                                <div class="card border-0">
                                    <div class="card-body py-1">
                                        <div class="d-flex justify-content-between">
                                            <strong>{{ c.writer_name }}</strong>
                                            <small class="text-muted">{{ c.created_at }}</small>
                                        </div>
                                        <p class="mb-1">{{ c.content }}</p>
                                        <button class="btn btn-sm text-secondary p-0" onclick="toggleReplyForm({{ c.id }})">ë‹µê¸€</button>

                                        <div id="reply-form-{{ c.id }}" class="mt-2 d-none">
                                            <div class="input-group input-group-sm">
                                                <input type="text" id="reply-input-{{ c.id }}" class="form-control" placeholder="ë‹µê¸€ ì…ë ¥">
                                                <button class="btn btn-secondary" onclick="submitComment({{ c.id }})">ë“±ë¡</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {% if c.children %}
                                    <div class="children-list">
                                        {{ render_comment(c.children) }}
                                    </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endmacro %}

                        <div id="comment-list">
                            {{ render_comment(comments) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // ì¢‹ì•„ìš” ê¸°ëŠ¥
    function toggleLike(boardId) {
        fetch(`/board/like/${boardId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const btn = document.getElementById('like-btn');
                const icon = document.getElementById('like-icon');
                const count = document.getElementById('like-count');
                count.innerText = data.like_count;
                if (data.is_liked) {
                    icon.innerText = 'â¤ï¸'; btn.classList.add('active');
                } else {
                    icon.innerText = 'ğŸ¤'; btn.classList.remove('active');
                }
            } else {
                alert(data.message);
                if (data.message.includes("ë¡œê·¸ì¸")) location.href = "/login";
            }
        });
    }

    // ë‹µê¸€ì°½ í† ê¸€
    function toggleReplyForm(commentId) {
        const target = document.getElementById(`reply-form-${commentId}`);
        target.classList.toggle('d-none');
    }

    // ëŒ“ê¸€ ë° ëŒ€ëŒ“ê¸€ í†µí•© ë“±ë¡ í•¨ìˆ˜
    function submitComment(parentId) {
        const content = parentId
            ? document.getElementById(`reply-input-${parentId}`).value
            : document.getElementById('comment-content').value;

        if (!content.trim()) {
            alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        fetch(`/board/comment/{{ board.id }}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                content: content,
                parent_id: parentId
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload(); // ì„±ê³µ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            } else {
                alert(data.message);
                if (data.message.includes("ë¡œê·¸ì¸")) location.href = "/login";
            }
        });
    }
    </script>
{% endblock %}